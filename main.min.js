define(function(){"use strict";function l(t,a){if(h.enabled()){if(d)return void(d=!1);a.batchOperation(function(){for(var e,r,s,n=0,t=u(),i=new Array(t+1).join(" ");void 0!==(e=a.getLine(n));){f.enabled()&&(r=/[ \t]+$/g,s=r.exec(e),s&&(a.replaceRange("",{line:n,ch:s.index},{line:n,ch:r.lastIndex}),e=a.getLine(n)));var c="",r=/^[ \t]+/g,o=/\t/g,d=new RegExp(i,"g");s=r.exec(e),s&&(c=s[0],p.enabled()&&(c=s[0].replace(o,i)),b.enabled()&&(c=s[0].replace(o,i).replace(d,"	")),a.replaceRange(c,{line:n,ch:s.index},{line:n,ch:r.lastIndex})),n+=1}n-=1,M.enabled()&&(e=a.getLine(n),void 0!==e&&e.length>0&&"\n"!==e.slice(-1)&&a.replaceRange("\n",{line:n+1,ch:e.slice(-1)}))}),d=!0,e.execute(n.FILE_SAVE,{doc:a})}}function u(){return a.getUseTabChar()?a.getTabSize():a.getSpaceUnits()}function g(e,n,t){this.name=e,this.label=n,this.commandId=r+(t?"."+t:""),this.command=this.registerCommand(),o.definePreference(this.name,"boolean","true"),this.set(o.get(this.name)),this.constructor.menu.addMenuItem(this.commandId)}var e=brackets.getModule("command/CommandManager"),n=brackets.getModule("command/Commands"),t=brackets.getModule("document/DocumentManager"),a=brackets.getModule("editor/Editor").Editor,i=brackets.getModule("command/Menus"),r="com.github.dsbonev.WhitespaceNormalizer",s=brackets.getModule("preferences/PreferencesManager"),c=r,o=s.getExtensionPrefs(c),d=!1;$(t).on("documentSaved",l),g.prototype={constructor:g,set:function(e){o.set(this.name,e),o.save(),this.command.setChecked(e)},toggle:function(){this.set(!this.command.getChecked())},enabled:function(){return"true"===this.value()||this.value()===!0},value:function(){return o.get(this.name)},registerCommand:function(){var n=this;return e.register(this.label,this.commandId,function(){n.toggle()})}},g.menu=i.getMenu(i.AppMenuBar.EDIT_MENU),g.menu.addMenuDivider();var h=new g("enabled","Enable Whitespace Normalizer",""),f=new g("trim","Trim trailing whitespace","trim"),b=new g("totabs","Normalize to tabs","totabs"),p=new g("transf","Normalize to spaces","transf"),M=new g("eofnl","End file with newline","eofnl")});